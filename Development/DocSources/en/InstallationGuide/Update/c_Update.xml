<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE concept PUBLIC "-//OASIS//DTD DITA Concept//EN"
                         "concept.dtd">
<!-- Copyright FUJITSU LIMITED 2017 -->
<concept id="Update"
                    xml:lang="en-us">
  <title>Update Installation</title>
  <conbody>
    <section>
      <p>Before updating your installation of <ph
                    audience="BSS"
                    conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/>, read the <i>Release Notes</i> of the new release. They contain information on compatibility issues, changes and enhancements, and known restrictions. </p>
      <p>
        <note>An update installation cannot change the authentication mode (INTERNAL or SAML_SP). You can only upgrade from an installation in INTERNAL mode to an installation in INTERNAL mode, or an installation in SAML_SP mode to an installation in SAML_SP mode. </note>
      </p>
    </section>
    
    
    <section>
      <title>Preparing the Update</title>
      <p>Before you start with the update installation, carry out the following steps: </p>
      <p>
        <ol
                            compact="no">
          <li>In the <codeph>bes-domain</codeph> and the <codeph>master-indexer-domain</codeph> domains, check whether all JMS messages have been processed. They are stored in the <codeph>bssjms</codeph> database. For example, check the JMS broker as follows:<p>For the <codeph>bes-domain</codeph> domain: </p><p>
              <codeblock>&lt;GLASSFISH_HOME&gt;/mq/bin/imqcmd.exe -b localhost:8076
   -u admin query bkr</codeblock>
            </p><p>For the <codeph>master-indexer-domain</codeph> domain: </p><p>
              <codeblock>&lt;GLASSFISH_HOME&gt;/mq/bin/imqcmd.exe -b localhost:8476
   -u admin query bkr</codeblock>
            </p><p>where <codeph>8076</codeph> or <codeph>8476</codeph> is the port where the JMS broker is running.</p><p>When executing the above command, you need to specify a password. The default password <codeph>admin</codeph> is defined in the <codeph>password.sample</codeph> file in the <codeph>&lt;GLASSFISH_HOME&gt;/mq/etc</codeph> directory. It is set automatically after the installation of GlassFish. You can also call the above command together with this password file, for example for the <codeph>bes-domain</codeph> domain: </p><p>
              <codeblock>&lt;GLASSFISH_HOME&gt;/mq/bin/imqcmd.exe -b localhost:8076
   -u admin query bkr -passfile ../etc/passfile.sample</codeblock>
            </p></li>
          <li>Set the following environment variable for your current session:<p><codeph>DB_INTERPRETER</codeph>: The absolute path and name of the <codeph>psql</codeph> executable of PostgreSQL. The executable is usually located in the <codeph>bin</codeph> subdirectory of the PostgreSQL installation directory.</p><p>Example:</p><codeblock>export DB_INTERPRETER="/opt/PostgreSQL/9.1/bin/psql"</codeblock>
          </li>
          <li>Copy the <codeph>configsettings.properties</codeph> file located in <codeph>&lt;install_pack_dir>/databases/bes_db</codeph> contains to a different location. Check whether the <codeph>configsettings.properties</codeph> file contained in the <ph
              conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"
              /> installation package new different or less settings than specified in the new <codeph>configsettings.properties</codeph> If you are upgrading from a release prior to <ph
              product="oscm_ce">16.0.5</ph><ph product="oscm_ee"              >V16.0 Fix 5</ph>, check and, if necessary, adapt the value of the <codeph>HIDE_PAYMENT_INFORMATION</codeph> configuration setting introduced with this release. By default, it is set to <codeph>false</codeph>. This setting is evaluated only once and cannot be changed anymore after <ph
              conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"                /> has been started. <p>The setting is made in the <codeph>configsettings.properties</codeph> file located in <codeph>&lt;install_pack_dir>/databases/bes_db</codeph>.</p></li>
          <li>If you are running <ph conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"                /> in SAML_SP mode:<p>In the <codeph>configsettings.properties</codeph> file located in <codeph>&lt;install_pack_dir>/databases/bes_db</codeph>, add the following configuration parameters and enter appropriate values:</p><p><codeph>SSO_DEFAULT_TENANT_ID</codeph></p><p><codeph>SSO_IDP_SAML_ASSERTION_ISSUER_ID</codeph></p><p>If you do not want to use the default value for the <codeph>KEY_FILE_PATH</codeph> configuration setting (<codeph>&lt;GLASSFISH_HOME>/glassfish/domains/bes-domain/config</codeph>), specify its value accordingly in the <codeph>configsettings.properties</codeph> file.</p>
          </li>
          <li>If you are running <ph
                            conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/> in SAML_SP mode and want to update or change STS-related configuration settings:<p>In the <codeph>configsettings.properties</codeph> file located in <codeph>&lt;install_pack_dir&gt;/databases/bes_db</codeph>, change the values for the following configuration parameters as required:</p><p><codeph>SSO_STS_ENCKEY_LEN</codeph></p><p><codeph>SSO_STS_METADATA_URL</codeph></p><p><codeph>SSO_STS_URL</codeph></p>
          </li>
          <li>If you are running <ph
                                conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/> in SAML_SP mode and want to make use of multiple tenants associated with IdP (Identity Provider) systems: <p>Apart from user IDs, the assertions returned to <ph
                                conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/> must contain the corresponding tenant ID for each user. This is required for <ph
                            conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/> to ensure the uniqueness of user IDs. </p><note>
              <p>Be aware that the SAML assertions returned from the IdP always need at least contain the default tenant ID in case you do not want to make use of the multi-tenancy functionality. </p>
            </note><p>To achieve this, the IdP must be configured such that its assertions contain an <codeph>&lt;Attribute&gt;</codeph> subelement with the <codeph>Name="tenantID"</codeph> property, and the <codeph>&lt;AttributeValue&gt;</codeph> subelement must specify the ID of the tenant associated with the organization the corresponding user belongs to.</p><p>Example: </p><p>
              <codeblock>&lt;saml:Assertion ...&gt;
    ...
    &lt;saml:AttributeStatement&gt;
      &lt;saml:Attribute Name="userid"&gt;
        &lt;saml:AttributeValue&gt;administrator&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
    &lt;saml:Attribute <b>Name="tenantID"</b>&gt;
        <b>&lt;saml:AttributeValue&gt;34ffd098&lt;/saml:AttributeValue&gt;</b>
      &lt;/saml:Attribute&gt;
    &lt;/saml:AttributeStatement&gt;
  &lt;/saml:Assertion&gt;
</codeblock>
            </p></li>
          <li>Proceed with updating your installation in the following sequence: <p>
              <ol>
                <li>Update you application server installation.</li>
                <li>Create backups of configuration and key files, and adjust the configuration settings for the new application server version. </li>
                <li>Update the database.</li>
                <li>Update the application server resources. </li>
                <li>If you are using certificates for authenticating Web service calls, or if you want to run <ph
                    conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"
                    /> in SAML_SP mode, you need to exchange the corresponding certificates again. Refer to the <i>Operator's Guide</i> for details on certificate handling.</li>
                <li>Deploy the BIRT report engine to be able to generate reports. Refer to <xref
                    href="../Installation/c_DeployBirt.xml"/> for details.</li>
              </ol>
            </p><p>See below for details.</p></li>
        </ol>
      </p>
    </section>
    <section id="must_be_deployed_on_an_appli_concept_conbody_section">
      <title>Updating the Application Server</title>
      <p><ph audience="BSS" conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"
        /> must be deployed on an application server compatible with Java EE version 7. The following application server is supported:</p>
      <p id="Oracle_GlassFish_Server_vers_concept_conbody_section_p_2">Oracle GlassFish Server, version 4.1.1.</p>
      <p audience="app">Proceed as described in <xref href="../../Shared/Installation/c_PrepAppServer.xml"/>. </p>
    </section>
    <section>
      <title>Creating Backups and Updating the Configuration Settings</title>
      <p>Proceed with updating your installation as follows:</p>
      <p>
        <ol compact="no">
          <li>Create a backup of the following files present in your old GlassFish 3 installation:<p>
              <ul>
                <li><codeph>configsettings.properties</codeph></li>
                <li><codeph>db.properties</codeph></li>
                <li><codeph>glassfish.properties</codeph> of both the <codeph>bes-domain</codeph> and the <codeph>indexer-domain</codeph> domains.</li>
                <li>Key file required for the encryption and decryption of service parameters with data type <codeph>PWD</codeph> or custom attributes marked for encryption. By default, the file is named <codeph>./key</codeph> and located in the following directory: <codeph>&lt;GLASSFISH3_HOME>/glassfish/domains/bes-domain/config</codeph></li>
              </ul>
            </p></li>
          <li>Check whether the <codeph>configsettings.properties</codeph> file contained in the new <ph
              conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"
            /> installation package to which you want to upgrade contains new, different, or less settings than your copy of the old file. </li>
          <li>Adjust the settings in the new <codeph>configsettings.properties</codeph> file located in the <codeph>&lt;install_pack_dir>/databases/bes_db</codeph> directory to your environment. Observe that especially the paths need to be adapted for the new application server installation.</li>
          <li>Copy the key file for encryption and decryption to the location you specified in the <codeph>KEY_FILE_PATH</codeph> setting in the new <codeph>configsettings.properties</codeph>. By default, this is<p><codeph>&lt;GLASSFISH_HOME>/glassfish/domains/bes-domain/config</codeph></p></li>
        </ol>
      </p>
    </section>
    <section>
      <title>Updating the Database</title>
      <p>Proceed with updating the database as follows:</p>
      <p>
        <ol compact="no">
          <li>Check whether the file <p><codeph>postgresql-9.1-903.jdbc4.jar</codeph></p><p> is contained in the following directories of the application server:</p><ul>
              <li><codeph>lib</codeph> directory of the <codeph>bes-domain</codeph> domain</li>
              <li><codeph>&lt;GLASSFISH_HOME&gt;/mq/lib/ext</codeph></li>
            </ul><p>If this is not the case, copy the file from the <codeph>&lt;install_pack_dir&gt;/install/lib</codeph> directory to the location where it is missing. </p></li>
          <li>Create a backup of the <ph><codeph>bss</codeph></ph> database using the standard PostgreSQL commands. The database backup must be compatible with PostgreSQL 9.1.12. <ph
              audience="BSS">Make sure to also have a backup of any customizations to marketplaces.</ph>
            <p>
              <note>Creating a backup of search index data is not required. The index will be automatically rebuilt when <ph
                  conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/> is operational again. </note>
            </p></li>
          <li>Update the following configuration files so that the settings match your current installation:<ul>
              <li><codeph>db.properties</codeph> located in <codeph>&lt;install_pack_dir&gt;/databases/bes_db</codeph></li>
              <li><codeph>configsettings.properties</codeph> located in <codeph>&lt;install_pack_dir&gt;/databases/bes_db</codeph></li>
              <li><codeph>sso.properties</codeph> located in <codeph>&lt;install_pack_dir&gt;/databases/bes_db</codeph></li>
            </ul></li>
          <li>Start the <codeph>bss</codeph> database.</li>
          <li>Update the schema and configuration settings of the <codeph>bss</codeph> database by executing the <codeph>build-db.xml</codeph> file in <codeph>&lt;install_pack_dir&gt;/install</codeph> as follows:<p>
              <codeblock>&lt;ANT_HOME&gt;/bin/ant -f build-db.xml updateDatabase</codeblock>
            </p><p>### is it true that the command is now as follows: ??? </p><p>
              <codeblock>&lt;ANT_HOME&gt;/bin/ant -f build-db.xml UPDATE.dbSchema</codeblock>
            </p><p>
              <note>
                <p>Make sure that Ant runs in a Java 8 runtime environment when calling the <codeph>build-db.xml</codeph> file. </p>
              </note>
            </p>
          </li>
        </ol>
      </p>
    </section>
    <section>
      <title>Updating the Application Server Resources</title>
      <p>
        <ol>
          <li>Delete the <codeph>master-indexer-domain</codeph> and the <codeph>master-indexer-domain</codeph> domains.</li>
          <li>Open the command prompt (Windows) or a terminal session (UNIX/Linux).</li>
          <li>Execute the <codeph>build-glassfish.xml</codeph> file in <codeph>&lt;install_pack_dir&gt;/install</codeph> as follows:<p>
              <codeblock>&lt;ANT_HOME&gt;/bin/ant -f build-glassfish.xml SETUP</codeblock>
            </p><p>This has the following results:<ul>
                <li>The <codeph>master-indexer-domain</codeph> domain is created and started. </li>
                <li>The search indexer application (<codeph>oscm-search.ear</codeph>) is deployed to the <codeph>master-indexer-domain</codeph> domain.</li>
                <li>The <codeph>bes-domain</codeph> domain is created and started. </li>
                <li>The following applications are deployed to the <codeph>bes-domain</codeph> domain: <p><codeph>oscm.ear</codeph></p><p><codeph>oscm-portal.war</codeph></p><p><codeph>oscm-portal-help.war</codeph></p><p
                    product="oscm_ee"><codeph>birt.war</codeph></p></li>
                <li>The <codeph>oscm-security.jar</codeph>, the <codeph>postgresql-9.1-903.jdbc4.jar</codeph>, and the <codeph>commons-codec-1.7.jar</codeph> files are copied from the directory to which you extracted the <ph
                    conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"
                    /> installation package (<codeph>&lt;install_pack_dir&gt;/domains/bes_domain/lib</codeph>) to the <codeph>lib</codeph> directory of the <codeph>bes-domain</codeph> domain.</li>
                <li>The required resources, email settings, JMS queues, data sources are created in the application server. Refer to <xref
                    href="../../Shared/reference/r_AppServerResources.xml"/> for details.</li>
                <li>The directory traversal is disabled for both domains, <codeph>bes-domain</codeph> and <codeph>master-indexer-domain</codeph>: The directory listing parameter is set to <codeph>false</codeph> in the <codeph>default-web.xml</codeph> file in the domain directories you are using for <ph
                    conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/>. </li>
              </ul></p></li>
        </ol>
      </p>
    </section>
    <section>
      <title>Updating the Command Line Tool</title>
      <p>The current version of the command line tool is provided in the <ph conref="../../Shared/Product_Name.xml#ProductNameTopic/Product_Abbr"/> installation package, <codeph>oscm-install-pack.zip</codeph>, as <codeph>oscm-operatorclient.zip</codeph>. If you want to use the command line tool with your updated installation, delete and install it again when finished with the update. For details on how to set up the tool, refer to the <i>Operator's Guide</i>.</p>
    </section>
    
  </conbody>
</concept>
